<!DOCTYPE html>
<html>

<head>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet'>
  <style>
    #editor {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      font-size: 18px;
      font-family: Inconsolata, monospace;
    }

    .ace_scroller.ace_scroll-left {
      box-shadow: initial !important;
    }
  </style>
</head>

<body>
  <div id='editor'></div>

  <script src='https://cdn.jsdelivr.net/gh/ajaxorg/ace-builds@1.4.5/src-min/ace.js'></script>
  <script src='https://cdn.jsdelivr.net/gh/ajaxorg/ace-builds@1.4.5/src-min/ext-modelist.js'></script>
  <script>
    function acePositionToIndex(start, lines) {
      let index = 0
      const row = Math.min(start.row, lines.length)
      for (let i = 0; i < row; ++i) {
        index += lines[i].length + 1
      }
      return index + start.column
    }

    const editor = ace.edit('editor', {
      cursorStyle: 'slim',
      useWorker: false
    })
    const modeList = ace.require('ace/ext/modelist')

    let listening = false
    let cancelEdits = { current: false }

    function log(message) {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'log',
        payload: message
      }))
    }

    function config(payload) {
      const { path, dark, canWrite, softWrapping, indentSize, softTabs } = payload
      const mode = modeList.getModeForPath(path).mode

      editor.setTheme(dark ? 'ace/theme/dracula' : 'ace/theme/github')
      editor.session.setMode(mode)
      editor.session.setUseWrapMode(softWrapping)
      editor.session.setUseSoftTabs(softTabs)
      editor.session.setTabSize(indentSize)

      if (!canWrite) {
        editor.setOptions({
          readOnly: true,
          highlightActiveLine: false,
          highlightGutterLine: false
        })
        editor.renderer.$cursorLayer.element.style.opacity = 0
        editor.textInput.getElement().tabIndex = -1
        editor.textInput.getElement().disabled = true
        editor.commands.commmandKeyBinding = {}
      } else if (!listening) {
        listening = true

        editor.session.on('change', function(delta) {
          if (cancelEdits.current) {
            log('cancelling')
            cancelEdits.current = false
            return
          }

          const prevLines = editor.session.getValue().split('\n')
          const skip = acePositionToIndex(delta.start, prevLines)

          const ops = []
          if (skip > 0) ops.push({ skip })
          const text = delta.lines.join('\n')
          if (delta.action === 'remove') {
            ops.push({ delete: text.length })
          } else {
            for (let char of [...text]) ops.push({ insert: char })
          }

          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'ot',
            payload: ops
          }))
        })
      }
    }

    function applyOps(ops) {
      log(`applying ot ops? count=${ops.length}`)
      const document = editor.session.getDocument()
      cancelEdits.current = true

      let cursor = 0
      for (const op of ops) {
        if (op.skip) {
          cursor += op.skip
        } else if (op.insert) {
          const position = document.indexToPosition(cursor, 0)
          editor.session.insert(position, op.insert)
        } else if (op.delete) {
          const start = document.indexToPosition(cursor, 0)
          const end = document.indexToPosition(cursor + op.delete)
          const range = new ace.Range(
            start.row,
            start.column,
            end.row,
            end.column,
          )
          session.remove(range)
        }
      }

      cancelEdits.current = false
    }

    document.addEventListener('message', (event) => {
      const message = JSON.parse(event.data)

      if (message.type === 'config') {
        config(message.payload)
      } else if (message.type === 'ot') {
        applyOps(message.payload)
      } else if (message.type === 'replace') {
        log('replacing')
        cancelEdits.current = true
        editor.setValue(message.payload)
        cancelEdits.current = false
      } else {
        log(`unknown ${message.type}`)
      }
    })

    if (window.ReactNativeWebView) {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'ready'
      }))
    } else {
      const interval = setInterval(() => {
        if (window.ReactNativeWebView) {
          clearInterval(interval)
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'ready'
          }))
        }
      }, 100)
    }
  </script>
</body>

</html>